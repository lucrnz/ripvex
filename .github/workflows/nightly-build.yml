name: Nightly Build

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: read
  packages: read
  actions: write

jobs:
  check-latest-dev:
    name: Check latest-dev tag digest
    runs-on: ubuntu-latest
    steps:
      - name: Compare latest-dev tag to current commit
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          OWNER="${{ github.repository_owner }}"
          REPO="${GITHUB_REPOSITORY#*/}"
          CURRENT_SHA="${GITHUB_SHA}"

          # Pull latest-dev image metadata
          if ! docker pull ghcr.io/${OWNER}/${REPO}:latest-dev 2>/dev/null; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "match=false" >> "$GITHUB_OUTPUT"
            echo "reason=missing_latest_dev" >> "$GITHUB_OUTPUT"
            echo "DEBUG: latest-dev tag not found or not pullable" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Extract commit SHA from image label
          LATEST_COMMIT=$(docker inspect ghcr.io/${OWNER}/${REPO}:latest-dev | \
            jq -r '.[0].Config.Labels["org.opencontainers.image.revision"] // empty')

          if [ -z "$LATEST_COMMIT" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "match=false" >> "$GITHUB_OUTPUT"
            echo "reason=missing_revision_label" >> "$GITHUB_OUTPUT"
            echo "DEBUG: latest-dev exists but has no revision label" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Debug output
          echo "DEBUG: Current commit: ${CURRENT_SHA}" >> $GITHUB_STEP_SUMMARY
          echo "DEBUG: Latest-dev commit: ${LATEST_COMMIT}" >> $GITHUB_STEP_SUMMARY

          # Compare commits
          if [ "$LATEST_COMMIT" = "$CURRENT_SHA" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "match=true" >> "$GITHUB_OUTPUT"
            echo "reason=commit_matches" >> "$GITHUB_OUTPUT"
            echo "âœ… Commits match - no build needed" >> $GITHUB_STEP_SUMMARY
          else
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "match=false" >> "$GITHUB_OUTPUT"
            echo "reason=commit_mismatch" >> "$GITHUB_OUTPUT"
            echo "ðŸ”„ Commits differ - build needed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Trigger build-and-release workflow
        if: steps.check.outputs.match != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-and-release.yml',
              ref: context.ref,
              inputs: {
                create_release: 'true',
                pre_release_build: 'true'
              }
            })

