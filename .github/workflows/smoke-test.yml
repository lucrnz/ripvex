name: Smoke Test

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  tar_payload_url: "https://github.com/lucrnz/ripvex/releases/download/ripvex-dev-20251206-704f87f/ripvex-dev-20251206-704f87f-amd64.tar.gz"
  tar_payload_hash: "06b733d2343ce63495526f0b79767da064ad7e7349250e8d5b94570d4161b771"
  tar_payload_content_hash: "26fe01ca29ec3a88351a5b5629c3a701a800133db609d86da736171750d57398"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Build ripvex
        run: make build

      - name: Upload ripvex binary
        uses: actions/upload-artifact@v4
        with:
          name: ripvex-binary
          path: build/ripvex
          retention-days: 1

  smoke-test-download:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download ripvex binary
        uses: actions/download-artifact@v4
        with:
          name: ripvex-binary

      - name: Make ripvex executable
        run: chmod +x ripvex

      - name: Smoke test download
        run: |
          ./ripvex -U "${{ env.tar_payload_url }}" -H "sha256:${{ env.tar_payload_hash }}" -O downloaded.tar.gz

      - name: Verify hash with sha256sum
        run: |
          echo "${{ env.tar_payload_hash }}  downloaded.tar.gz" | sha256sum -c

      - name: Clean up downloaded file
        run: rm -f downloaded.tar.gz

  smoke-test-extract:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download ripvex binary
        uses: actions/download-artifact@v4
        with:
          name: ripvex-binary

      - name: Make ripvex executable
        run: chmod +x ripvex

      - name: Smoke test download and extract
        run: |
          ./ripvex -U "${{ env.tar_payload_url }}" -H "sha256:${{ env.tar_payload_hash }}" -x

      - name: Verify ripvex-amd64 directory exists
        run: |
          test -d ripvex-amd64 || (echo "Directory ripvex-amd64 does not exist" && exit 1)

      - name: Verify ripvex-amd64/ripvex file exists
        run: |
          test -f ripvex-amd64/ripvex || (echo "File ripvex-amd64/ripvex does not exist" && exit 1)

      - name: Verify extracted file hash
        run: |
          echo "${{ env.tar_payload_content_hash }}  ripvex-amd64/ripvex" | sha256sum -c

