name: AI Review

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  review:
    runs-on: ubuntu-latest
    env:
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      CRUSH_URL: "https://github.com/charmbracelet/crush/releases/download/v0.21.0/crush_0.21.0_Linux_x86_64.tar.gz"
      CRUSH_HASH_SHA256: "efa1642e4b3f8d49381e709cdb72eb98d710ccb9626019f395fa741144af7e31"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Install crush
        run: |
          mkdir -p $HOME/bin
          DOWNLOAD_DIR=$(mktemp -d)
          pushd $DOWNLOAD_DIR
          curl -fL -o crush.tgz "${{ env.CRUSH_URL }}"
          echo "${{ env.CRUSH_HASH_SHA256 }}  crush.tgz" | sha256sum -c
          tar --strip-components=1 -xzf crush.tgz
          rm -f crush.tgz
          mv crush $HOME/bin/crush
          popd
          rm -rf $DOWNLOAD_DIR

      - name: Update crush providers
        run: |
          $HOME/bin/crush update-providers

      - name: Setup crush config
        run: |
          mkdir -p $HOME/.local/share/crush
          ## setup default models
          cat > $HOME/.local/share/crush/crush.json << 'EOF'
          {
            "models": {
              "large": {"model":"deepseek/deepseek-v3.2","provider":"openrouter","reasoning_effort":"high","max_tokens":32768},
              "small": {"model":"deepseek/deepseek-v3.2","provider":"openrouter","reasoning_effort":"medium","max_tokens":32768}
            }
          }
          EOF

      - name: Run prompt
        run: |
          $HOME/bin/crush run "Read the contents of the file .llm/prompts/review.md and follow the instructions."
          test -f review.md || (echo "review file not found" && exit 1)
          test -f review-results.json || (echo "review results file not found" && exit 1)
          jq '.containsCriticalIssues' review-results.json | grep -q 'false' || (echo "Critical issues found" && exit 1)

      - name: Display review summary
        if: always()
        run: |
          if [ -f review.md ]; then
            cat review.md >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ review.md file not found" >> $GITHUB_STEP_SUMMARY
          fi
